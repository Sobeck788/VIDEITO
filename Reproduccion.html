<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproduciendo - VideITO</title>
    <link rel="stylesheet" href="Stilos.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-section">
                <a href="/" class="logo">VideITO</a>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Buscar videos...">
                    <button class="search-button" onclick="buscarVideos()">Buscar</button>
                </div>
            </div>
            
            <div class="location-user-section">
                <div class="user-location" id="locationDisplay">
                    Tu ubicaci√≥n: <span id="currentLocation">Oaxaca</span>
                </div>
                
                <div class="user-menu">
                    <button class="user-button" id="userMenuButton">
                        <div class="user-authenticated">
                            <div class="user-avatar"></div>
                            <span id="userName">Usuario</span>
                        </div>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="/perfil" class="dropdown-item">Mi Perfil</a>
                        <a href="/historial" class="dropdown-item">Historial</a>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" onclick="cerrarSesion()">Salir</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="video-player-container">
            <div class="player-section">
                <div class="video-player" id="videoPlayer">
                    <div class="loading-player">Cargando video...</div>
                </div>
                
                <div class="video-info-detailed">
                    <h1 class="video-title-detailed" id="videoTitle">Cargando...</h1>
                    <div class="video-stats-detailed">
                        <span class="view-count" id="viewCount">- vistas</span>
                        <span class="like-count" id="likeCount">- me gusta</span>
                        <span class="publish-date" id="publishDate">-</span>
                    </div>
                    <div class="channel-info">
                        <div class="channel-avatar" id="channelAvatar"></div>
                        <div class="channel-details">
                            <div class="channel-name" id="channelName">Cargando...</div>
                            <div class="subscriber-count" id="subscriberCount">- suscriptores</div>
                        </div>
                        <button class="subscribe-btn" onclick="suscribirse()">Suscribirse</button>
                    </div>
                    <div class="video-description-detailed" id="videoDescription">
                        Cargando descripci√≥n...
                    </div>
                </div>
            </div>

            <div class="suggestions-section">
                <h3 class="suggestions-title">Sugerencias</h3>
                <div class="suggestions-list" id="suggestionsList">
                    <div class="loading">Cargando sugerencias...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- YouTube IFrame API -->
    <script>
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    </script>

    <script>
        let player = null;
        let currentVideoId = null;
        let currentLocation = 'Oaxaca';
        let currentSearch = '';

        // Obtener par√°metros de la URL
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                v: urlParams.get('v'), // video ID
                location: urlParams.get('location') || 'Oaxaca',
                search: urlParams.get('search') || ''
            };
        }

        // Cuando YouTube API est√© lista
        function onYouTubeIframeAPIReady() {
            console.log('‚úÖ YouTube API lista');
            const params = getUrlParams();
            
            if (params.v) {
                currentVideoId = params.v;
                currentLocation = params.location;
                currentSearch = params.search;
                
                cargarVideo(currentVideoId);
                cargarSugerencias(currentLocation, currentSearch);
                
                // Actualizar ubicaci√≥n en la UI
                document.getElementById('currentLocation').textContent = currentLocation;
            } else {
                document.getElementById('videoPlayer').innerHTML = 
                    '<div class="error">No se especific√≥ un video para reproducir</div>';
            }
        }

        // Cargar y reproducir el video
        function cargarVideo(videoId) {
            console.log('üé¨ Cargando video:', videoId);
            
            player = new YT.Player('videoPlayer', {
                height: '500',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'playsinline': 1,
                    'rel': 0,
                    'modestbranding': 1,
                    'autoplay': 1,
                    'controls': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            console.log('‚úÖ Reproductor listo');
            obtenerInformacionVideo(currentVideoId);
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                console.log('‚ñ∂Ô∏è Video reproduci√©ndose');
            }
        }

        function onPlayerError(error) {
            console.error('‚ùå Error en reproductor:', error);
            document.getElementById('videoPlayer').innerHTML = 
                '<div class="error">Error al cargar el video</div>';
        }

        // Obtener informaci√≥n del video
        async function obtenerInformacionVideo(videoId) {
            try {
                const response = await fetch(`/api/video-info?v=${videoId}`);
                const data = await response.json();
                
                if (data.success) {
                    mostrarInformacionVideo(data.video);
                } else {
                    mostrarInformacionPorDefecto(videoId);
                }
            } catch (error) {
                console.error('Error obteniendo informaci√≥n:', error);
                mostrarInformacionPorDefecto(videoId);
            }
        }

        function mostrarInformacionVideo(video) {
            document.getElementById('videoTitle').textContent = video.title;
            document.getElementById('viewCount').textContent = `${formatearNumero(video.viewCount)} vistas`;
            document.getElementById('likeCount').textContent = `${formatearNumero(video.likeCount)} me gusta`;
            document.getElementById('publishDate').textContent = formatearFecha(video.publishedAt);
            document.getElementById('channelName').textContent = video.channelTitle;
            document.getElementById('videoDescription').textContent = video.description || 'Descripci√≥n no disponible';
            
            // Avatar del canal
            const channelAvatar = document.getElementById('channelAvatar');
            channelAvatar.textContent = video.channelTitle.charAt(0).toUpperCase();
            channelAvatar.style.background = generarColorDesdeTexto(video.channelTitle);
        }

        function mostrarInformacionPorDefecto(videoId) {
            document.getElementById('videoTitle').textContent = 'Video de YouTube';
            document.getElementById('channelName').textContent = 'Canal de YouTube';
            document.getElementById('videoDescription').textContent = 'Descripci√≥n no disponible';
        }

        // Cargar videos sugeridos
        async function cargarSugerencias(location, search) {
            try {
                const response = await fetch(`/api/videos?location=${location}&search=${search}&maxResults=8`);
                const data = await response.json();
                
                if (data.success) {
                    mostrarSugerencias(data.videos);
                }
            } catch (error) {
                console.error('Error cargando sugerencias:', error);
                document.getElementById('suggestionsList').innerHTML = 
                    '<div class="error">Error cargando sugerencias</div>';
            }
        }

        function mostrarSugerencias(videos) {
            const suggestionsList = document.getElementById('suggestionsList');
            
            // Filtrar el video actual de las sugerencias
            const sugerenciasFiltradas = videos.filter(video => video.id !== currentVideoId).slice(0, 6);
            
            if (sugerenciasFiltradas.length === 0) {
                suggestionsList.innerHTML = '<div class="no-data">No hay sugerencias disponibles</div>';
                return;
            }

            suggestionsList.innerHTML = sugerenciasFiltradas.map(video => `
                <div class="suggestion-item" onclick="cambiarVideo('${video.id}')">
                    <div class="suggestion-thumbnail" style="background-image: url('${video.thumbnail}')"></div>
                    <div class="suggestion-info">
                        <div class="suggestion-title">${video.title.substring(0, 50)}${video.title.length > 50 ? '...' : ''}</div>
                        <div class="suggestion-channel">${video.channelTitle}</div>
                        <div class="suggestion-views">${formatearNumero(video.viewCount || '0')} vistas</div>
                    </div>
                </div>
            `).join('');
        }

        // Cambiar a otro video
        function cambiarVideo(nuevoVideoId) {
            // Actualizar URL sin recargar la p√°gina
            const nuevaUrl = `${window.location.pathname}?v=${nuevoVideoId}&location=${currentLocation}&search=${currentSearch}`;
            window.history.pushState({}, '', nuevaUrl);
            
            currentVideoId = nuevoVideoId;
            
            // Recargar el video
            if (player) {
                player.loadVideoById(nuevoVideoId);
                player.playVideo();
            } else {
                cargarVideo(nuevoVideoId);
            }
            
            // Recargar informaci√≥n y sugerencias
            obtenerInformacionVideo(nuevoVideoId);
            cargarSugerencias(currentLocation, currentSearch);
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Utilidades
        function formatearFecha(fecha) {
            const date = new Date(fecha);
            return date.toLocaleDateString('es-MX', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function formatearNumero(num) {
            const number = parseInt(num);
            if (number >= 1000000) {
                return (number / 1000000).toFixed(1) + 'M';
            } else if (number >= 1000) {
                return (number / 1000).toFixed(1) + 'K';
            }
            return number.toLocaleString('es-MX');
        }

        function generarColorDesdeTexto(texto) {
            let hash = 0;
            for (let i = 0; i < texto.length; i++) {
                hash = texto.charCodeAt(i) + ((hash << 5) - hash);
            }
            const colores = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
            return colores[Math.abs(hash) % colores.length];
        }

        function suscribirse() {
            alert('Funcionalidad de suscripci√≥n en desarrollo');
        }

        // Navegaci√≥n
        function buscarVideos() {
            const searchInput = document.getElementById('searchInput');
            const search = searchInput.value.trim();
            
            if (search) {
                window.location.href = `/?search=${encodeURIComponent(search)}`;
            }
        }

        // Men√∫ de usuario
        document.addEventListener('DOMContentLoaded', function() {
            const userMenuButton = document.getElementById('userMenuButton');
            const dropdownMenu = document.getElementById('dropdownMenu');

            if (userMenuButton && dropdownMenu) {
                userMenuButton.addEventListener('click', function() {
                    dropdownMenu.classList.toggle('show');
                });

                window.addEventListener('click', function(e) {
                    if (!e.target.matches('.user-button') && !e.target.closest('.user-button')) {
                        if (dropdownMenu.classList.contains('show')) {
                            dropdownMenu.classList.remove('show');
                        }
                    }
                });
            }

            // Configurar b√∫squeda con Enter
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        buscarVideos();
                    }
                });
            }
        });

        function cerrarSesion() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                alert('Sesi√≥n cerrada');
                window.location.href = '/';
            }
            const dropdownMenu = document.getElementById('dropdownMenu');
            if (dropdownMenu) {
                dropdownMenu.classList.remove('show');
            }
        }

        // Manejar navegaci√≥n con el bot√≥n atr√°s/adelante
        window.addEventListener('popstate', function() {
            const params = getUrlParams();
            if (params.v && params.v !== currentVideoId) {
                cambiarVideo(params.v);
            }
        });
    </script>
</body>
</html>
